<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Thinking...]]></title>
  <link href="http://kaihaodir.github.io/atom.xml" rel="self"/>
  <link href="http://kaihaodir.github.io/"/>
  <updated>2016-08-13T17:21:45+08:00</updated>
  <id>http://kaihaodir.github.io/</id>
  <author>
    <name><![CDATA[Kai]]></name>
    <email><![CDATA[kaihaodir@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[å¤šçº¿ç¨‹ä¸‹é€šçŸ¥å“åº”å‡½æ•°Crash]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/08/13/mutithread-notification-crash/"/>
    <updated>2016-08-13T16:32:26+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/08/13/mutithread-notification-crash</id>
    <content type="html"><![CDATA[<p>ä»Šå¤©å‘ç°ä¸€ä¸ªè€é—®é¢˜å¼•èµ·çš„å´©æºƒï¼Œè®°å½•ä¸€ä¸‹ã€‚</p>

<p>å…ˆæœ‰é—®é¢˜çš„ä»£ç ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>@implementation LogicHandle
</span><span class='line'>
</span><span class='line'>- (instancetype)init
</span><span class='line'>{
</span><span class='line'>    if (self = [super init]) {
</span><span class='line'>        [[NSNotificationCenter defaultCenter] addObserver:self
</span><span class='line'>                                                 selector:@selector(onNotification)
</span><span class='line'>                                                     name:@"kLogicNotification" object:nil];
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return self;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)dealloc
</span><span class='line'>{
</span><span class='line'>    [[NSNotificationCenter defaultCenter] removeObserver:self];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)onNotification
</span><span class='line'>{
</span><span class='line'>    [self showLog];
</span><span class='line'>    [self showLog];
</span><span class='line'>    [self showLog];
</span><span class='line'>    [self showLog];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)showLog
</span><span class='line'>{
</span><span class='line'>  NSLog(@"%@", self);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@end
</span><span class='line'>//Posté€šçŸ¥ä»£ç 
</span><span class='line'>- (void)postNotificationInBackground
</span><span class='line'>{
</span><span class='line'>    dispatch_sync(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
</span><span class='line'>        [[NSNotificationCenter defaultCenter] postNotificationName:kLogicNotification object:nil];
</span><span class='line'>    });
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<!--MORE-->


<p>å¸¸è§„çš„é€šçŸ¥æ¥æ”¶æ¨¡å‹å¤§è‡´éƒ½æ˜¯è¿™æ ·æ ¼å¼ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼åœ¨å¤„ç†å¤šçº¿ç¨‹çš„è°ƒç”¨æ—¶ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>ç”±äºPostNotificationæ˜¯åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ï¼Œæ‰€ä»¥ <code>onNotification</code> ä¹Ÿä¼šåœ¨å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚ è¿™ä¸ªæ—¶å€™å¾ˆå¤šäººä¼šè®¤ä¸ºæ˜¯ä¸æ˜¯å¤šçº¿ç¨‹è®¿é—®å¯¹è±¡å¼•èµ·çš„å´©æºƒï¼Ÿé‚£åŠ ä¸ªé”å¯ä»¥è§£å†³é—®é¢˜å—ï¼Ÿ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)onNotification
</span><span class='line'>{
</span><span class='line'>  @synchronized (self) {
</span><span class='line'>      xxx;
</span><span class='line'>      xxx;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ²¡é”™ï¼Œ å¤šçº¿ç¨‹è®¿é—®æ•°æ®æ—¶ä¼šæœ‰é—®é¢˜ï¼Œä½†å¾ˆæ˜æ˜¾è¿™é‡Œåªæ˜¯è¾“å‡ºä¸€ä¸‹ selfï¼Œ å¹¶æ²¡æœ‰æ¶‰åŠåˆ°æ•°æ®çš„ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼çš„åŠ é”æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„ã€‚</p>

<p>ä¸»è¦åŸå› æ˜¯å½“åå°çº¿ç¨‹åœ¨æ‰§è¡Œ <code>onNotification</code> æ–¹æ³•çš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ°ä¸€åŠï¼Œå…¶ä»–çº¿ç¨‹æŠŠå¯¹è±¡é‡Šæ”¾äº†ã€‚</p>

<h3>è§£å†³æ–¹æ³•ï¼š</h3>

<ul>
<li>ä¿è¯åœ¨åŒä¸€çº¿ç¨‹å‘é€šçŸ¥</li>
<li>å¦‚æœè¦æ”¯æŒå¤šçº¿ç¨‹è°ƒç”¨ï¼Œå¯ä»¥ç”¨ &ldquo;å¼ºå¼•ç”¨&rdquo; ç¡®ä¿å¯¹è±¡ä¸è¢«é‡Šæ”¾ã€‚</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)mutithread_message
</span><span class='line'>{
</span><span class='line'>  __strong __typeof(self) strongSelf = self;
</span><span class='line'>  [strongSelf op];
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§å…¶å®å°±æ˜¯ block é‡Œé¢å¸¸è§„çš„  weak-strong çš„å†™æ³•ï¼Œåªæ˜¯å¾ˆå°‘ä¼šç›´æ¥å†™åˆ°å‡½æ•°é‡Œé¢ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hook __NSArrayM objectAtIndex Caush UIKeyboardTaskEntry Crash]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/06/08/hook-nsarraym-objectatindex-keyboard-crash/"/>
    <updated>2016-06-08T16:27:22+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/06/08/hook-nsarraym-objectatindex-keyboard-crash</id>
    <content type="html"><![CDATA[<h3>å‰é¢˜</h3>

<pre><code>ä¸ºäº†ç»Ÿä¸€å¤„ç†æ•°ç»„è¶Šç•Œçš„é—®é¢˜ï¼Œæˆ‘ä»¬ HOOK __NSArrayM çš„ objectAtIndex: æ–¹æ³•
</code></pre>

<h3>é—®é¢˜ï¼š</h3>

<pre><code>åœ¨å¯ä»¥è¾“å…¥æ–‡å­—çš„é¡µé¢ï¼Œä½¿ç”¨"è‹±æ–‡"é”®ç›˜è¾“å…¥ï¼Œè§¦å‘è”æƒ³åŠŸèƒ½ï¼Œç„¶ååˆ‡æ¢åˆ°åå°ï¼Œå†æ¿€æ´»ç¨‹åºï¼Œéšä¾¿ç‚¹ä¸€ä¸‹å°±ä¼šå´©æºƒã€‚
</code></pre>

<h3>å´©æºƒå †æ ˆï¼š</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) bt
</span><span class='line'>* thread #1: tid = 0xf9f0c, 0x0000000182aadb9c libobjc.A.dylib`objc_msgSend + 28, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x61746572847637e1)
</span><span class='line'>    frame #0: 0x0000000182aadb9c libobjc.A.dylib`objc_msgSend + 28
</span><span class='line'>    frame #1: 0x0000000182ab5288 libobjc.A.dylib`objc_object::sidetable_release(bool) + 220
</span><span class='line'>    frame #2: 0x0000000182edd8e8 libsystem_blocks.dylib`_Block_release + 156
</span><span class='line'>    frame #3: 0x0000000188f256b0 UIKit`-[UIKeyboardTaskEntry dealloc] + 44
</span><span class='line'>  * frame #4: 0x00000001000ba5dc KeyboardCrash`-[MethodsHooker myRelease](self=0x000000014df0c140, _cmd="release") + 308 at MethodsHooker.m:138
</span><span class='line'>    frame #5: 0x0000000182ab5ae8 libobjc.A.dylib`(anonymous namespace)::AutoreleasePoolPage::pop(void*) + 508
</span><span class='line'>    frame #6: 0x00000001833149fc CoreFoundation`_CFAutoreleasePoolPop + 28
</span><span class='line'>    frame #7: 0x00000001888549e4 UIKit`_prepareForCAFlush + 352
</span><span class='line'>    frame #8: 0x0000000188592fa4 UIKit`_UIApplicationHandleEventQueue + 4900
</span><span class='line'>    frame #9: 0x00000001833ed09c CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 24
</span><span class='line'>    frame #10: 0x00000001833ecb30 CoreFoundation`__CFRunLoopDoSources0 + 540
</span><span class='line'>    frame #11: 0x00000001833ea830 CoreFoundation`__CFRunLoopRun + 724
</span><span class='line'>    frame #12: 0x0000000183314c50 CoreFoundation`CFRunLoopRunSpecific + 384
</span><span class='line'>    frame #13: 0x0000000184bfc088 GraphicsServices`GSEventRunModal + 180
</span><span class='line'>    frame #14: 0x00000001885fe088 UIKit`UIApplicationMain + 204
</span><span class='line'>    frame #15: 0x00000001000ba73c KeyboardCrash`main(argc=1, argv=0x000000016fd4baf8) + 124 at main.m:14
</span><span class='line'>    frame #16: 0x0000000182eb28b8 libdyld.dylib`start + 4</span></code></pre></td></tr></table></div></figure>


<p>è®¾ç½®<strong>å¼‚å¸¸æ–­ç‚¹</strong>å’Œ<strong>Enable Zombie Objects</strong>åï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼š</p>

<blockquote><p>2016-06-08 16:50:12.430 KeyboardCrash[1487:1026067] *** -[UIKeyboardLayoutStar release]: message sent to deallocated instance 0x1580b6600</p></blockquote>

<p>ä¸»è¦æ˜¯å› ä¸º<code>UIKeyboardLayoutStar</code>å¯¹è±¡å·²é”€æ¯äº†ï¼Œä½†è¿˜æœ‰äººè°ƒç”¨ <code>-[UIKeyboardLayoutStar release]</code> å¼•èµ·çš„ã€‚</p>

<h2>åˆ†æè¿‡ç¨‹</h2>

<ul>
<li>æ–°å®ç°çš„æ–¹æ³•</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (instancetype)mySelfMutableObjectAtIndex:(NSUInteger)index
</span><span class='line'>{
</span><span class='line'>    
</span><span class='line'>    NSArray *array = (NSArray *)self;
</span><span class='line'>    if (array.count &lt;= index) {
</span><span class='line'>        return nil;
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return [self originalMutableObjectAtIndex:index];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåº”è¯¥ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚äºæ˜¯æˆ‘åˆæŠŠåˆ¤æ–­æ¡ä»¶å»æ‰ï¼Œæ”¹æˆè¿™æ ·</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (instancetype)mySelfMutableObjectAtIndex:(NSUInteger)index
</span><span class='line'>{   
</span><span class='line'>    return [self originalMutableObjectAtIndex:index];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¥‡æ€ªçš„å‘ç°ï¼Œé—®é¢˜å±…ç„¶æ²¡æœ‰å‡ºç°äº†ã€‚é‚£ä¸ºä»€ä¹ˆåŠ äº†åˆ¤æ–­æ¡ä»¶ä¼šæœ‰é—®é¢˜ï¼Œåˆ°åº•è¿™ä¸¤ä¸ªå‡½æ•°æœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p>

<p>äºæ˜¯åæ±‡ç¼–å¯¹æ¯”äº†ä¸€ä¸‹</p>

<p><strong>æ²¡åŠ åˆ¤æ–­æ¡ä»¶çš„æ±‡ç¼–ä»£ç :</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KeyboardCrash`-[MethodsHooker mySelfMutableObjectAtIndex:]:
</span><span class='line'>    0x1000c624c &lt;+0&gt;:  stp    x29, x30, [sp, #-16]!
</span><span class='line'>    0x1000c6250 &lt;+4&gt;:  mov    x29, sp
</span><span class='line'>    0x1000c6254 &lt;+8&gt;:  sub    sp, sp, #32               ; =32 
</span><span class='line'>    0x1000c6258 &lt;+12&gt;: adrp   x8, 3
</span><span class='line'>    0x1000c625c &lt;+16&gt;: add    x8, x8, #216              ; =216 
</span><span class='line'>    0x1000c6260 &lt;+20&gt;: stur   x0, [x29, #-8]
</span><span class='line'>    0x1000c6264 &lt;+24&gt;: str    x1, [sp, #16]
</span><span class='line'>    0x1000c6268 &lt;+28&gt;: str    x2, [sp, #8]
</span><span class='line'>-&gt;  0x1000c626c &lt;+32&gt;: ldur   x0, [x29, #-8]
</span><span class='line'>    0x1000c6270 &lt;+36&gt;: ldr    x2, [sp, #8]
</span><span class='line'>    0x1000c6274 &lt;+40&gt;: ldr    x1, [x8]
</span><span class='line'>    0x1000c6278 &lt;+44&gt;: bl     0x1000c684c               ; symbol stub for: objc_msgSend
</span><span class='line'>    0x1000c627c &lt;+48&gt;: mov    sp, x29
</span><span class='line'>    0x1000c6280 &lt;+52&gt;: ldp    x29, x30, [sp], #16
</span><span class='line'>    0x1000c6284 &lt;+56&gt;: ret    </span></code></pre></td></tr></table></div></figure>


<p><strong>åŠ äº†åˆ¤æ–­çš„æ±‡ç¼–ä»£ç ï¼š</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) dis
</span><span class='line'>KeyboardCrash`-[MethodsHooker mySelfMutableObjectAtIndex:]:
</span><span class='line'>    0x1000ca1c8 &lt;+0&gt;:   stp    x29, x30, [sp, #-16]!
</span><span class='line'>    0x1000ca1cc &lt;+4&gt;:   mov    x29, sp
</span><span class='line'>    0x1000ca1d0 &lt;+8&gt;:   sub    sp, sp, #48               ; =48 
</span><span class='line'>    0x1000ca1d4 &lt;+12&gt;:  stur   x0, [x29, #-16]
</span><span class='line'>    0x1000ca1d8 &lt;+16&gt;:  str    x1, [sp, #24]
</span><span class='line'>    0x1000ca1dc &lt;+20&gt;:  str    x2, [sp, #16]
</span><span class='line'>-&gt;  0x1000ca1e0 &lt;+24&gt;:  ldur   x0, [x29, #-16]
</span><span class='line'>    0x1000ca1e4 &lt;+28&gt;:  bl     0x1000ca854               ; symbol stub for: objc_retain
</span><span class='line'>    0x1000ca1e8 &lt;+32&gt;:  adrp   x1, 3
</span><span class='line'>    0x1000ca1ec &lt;+36&gt;:  add    x1, x1, #256              ; =256 
</span><span class='line'>    0x1000ca1f0 &lt;+40&gt;:  str    x0, [sp, #8]
</span><span class='line'>    0x1000ca1f4 &lt;+44&gt;:  ldr    x0, [sp, #8]
</span><span class='line'>    0x1000ca1f8 &lt;+48&gt;:  ldr    x1, [x1]
</span><span class='line'>    0x1000ca1fc &lt;+52&gt;:  bl     0x1000ca830               ; symbol stub for: objc_msgSend
</span><span class='line'>    0x1000ca200 &lt;+56&gt;:  ldr    x1, [sp, #16]
</span><span class='line'>    0x1000ca204 &lt;+60&gt;:  cmp    x0, x1
</span><span class='line'>    0x1000ca208 &lt;+64&gt;:  b.hi   0x1000ca220               ; &lt;+88&gt; at MethodsHooker.m:60
</span><span class='line'>    0x1000ca20c &lt;+68&gt;:  orr    w8, wzr, #0x1
</span><span class='line'>    0x1000ca210 &lt;+72&gt;:  movz   x9, #0
</span><span class='line'>    0x1000ca214 &lt;+76&gt;:  stur   x9, [x29, #-8]
</span><span class='line'>    0x1000ca218 &lt;+80&gt;:  str    w8, [sp, #4]
</span><span class='line'>    0x1000ca21c &lt;+84&gt;:  b      0x1000ca250               ; &lt;+136&gt; at MethodsHooker.m:63
</span><span class='line'>    0x1000ca220 &lt;+88&gt;:  adrp   x8, 3
</span><span class='line'>    0x1000ca224 &lt;+92&gt;:  add    x8, x8, #224              ; =224 
</span><span class='line'>    0x1000ca228 &lt;+96&gt;:  ldur   x9, [x29, #-16]
</span><span class='line'>    0x1000ca22c &lt;+100&gt;: ldr    x2, [sp, #16]
</span><span class='line'>    0x1000ca230 &lt;+104&gt;: ldr    x1, [x8]
</span><span class='line'>    0x1000ca234 &lt;+108&gt;: mov    x0, x9
</span><span class='line'>    0x1000ca238 &lt;+112&gt;: bl     0x1000ca830               ; symbol stub for: objc_msgSend
</span><span class='line'>    0x1000ca23c &lt;+116&gt;: mov    x29, x29
</span><span class='line'>    0x1000ca240 &lt;+120&gt;: bl     0x1000ca860               ; symbol stub for: objc_retainAutoreleasedReturnValue
</span><span class='line'>    0x1000ca244 &lt;+124&gt;: orr    w10, wzr, #0x1
</span><span class='line'>    0x1000ca248 &lt;+128&gt;: stur   x0, [x29, #-8]
</span><span class='line'>    0x1000ca24c &lt;+132&gt;: str    w10, [sp, #4]
</span><span class='line'>    0x1000ca250 &lt;+136&gt;: add    x0, sp, #8                ; =8 
</span><span class='line'>    0x1000ca254 &lt;+140&gt;: movz   x1, #0
</span><span class='line'>    0x1000ca258 &lt;+144&gt;: bl     0x1000ca86c               ; symbol stub for: objc_storeStrong
</span><span class='line'>    0x1000ca25c &lt;+148&gt;: ldur   x0, [x29, #-8]
</span><span class='line'>    0x1000ca260 &lt;+152&gt;: mov    sp, x29
</span><span class='line'>    0x1000ca264 &lt;+156&gt;: ldp    x29, x30, [sp], #16
</span><span class='line'>    0x1000ca268 &lt;+160&gt;: b      0x1000ca80c               ; symbol stub for: objc_autoreleaseReturnValue
</span><span class='line'>    </span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ°ï¼Œ æ·»åŠ äº†å‡ å¥åˆ¤æ–­è¯­å¥åï¼Œ ç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬æ·»åŠ äº†ä¸€äº› objc_retain, objc_storeStrong(release), å’Œ objc_autoreleaseReturnValue æ§åˆ¶å¼•ç”¨è®¡æ•°çš„å‡½æ•°ã€‚
è€Œåœ¨å‡½æ•°æœ€åè¿”å›çš„æ—¶å€™æ˜¯è°ƒç”¨äº†  objc_autoreleaseReturnValue è¿™ä¸ªå‡½æ•°ã€‚</p>

<p>ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿ <code>UIKeyboardLayoutStar</code> å¯¹è±¡çš„å¼•ç”¨æŠ€æœ¯å˜åŒ–ï¼Œ æˆ‘HOOKäº† <code>NSObject</code> çš„ <code>retain</code>, <code>release</code>, <code>autorelease</code> å‡½æ•°ï¼Œ å¹¶ä¸”æŠŠå½“å‰çš„å¼•ç”¨è®¡æ•°ï¼ˆ<code>retainCount</code>ï¼‰æ‰“å°å‡ºæ¥ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LLDB Command]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/06/03/lldb-command/"/>
    <updated>2016-06-03T16:36:26+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/06/03/lldb-command</id>
    <content type="html"><![CDATA[<h3>è®¾ç½®æ–­ç‚¹ï¼š</h3>

<ul>
<li><p>å¯¹æ‰€æœ‰Cå‡½æ•° functionA è®¾ç½®æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;name functionnameA &ndash;name functionNameB</p></li>
<li><p>br s -n functionA</p></li>
<li><p>b functionA</p></li>
</ul>
</li>
</ul>


<!--MORE-->


<ul>
<li><p>å¯¹FileAæ–‡ä»¶çš„LineNumè¡Œè®¾ç½®æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;file FileA &ndash;line LineNumber</p></li>
<li><p>b fileA:LineNumber</p></li>
</ul>
</li>
<li><p>C++ å‡½æ•°ï¼Œ å¯¹æ‰€æœ‰C++ çš„ foo å‡½æ•°è®¾ç½®æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;method foo</p></li>
<li><p>br s -M foo</p></li>
</ul>
</li>
<li><p>OC å¯¹æ‰€æœ‰ aSelector è®¾ç½®æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;selector aSelector</p></li>
<li><p>br s -S aSelectro</p></li>
</ul>
</li>
<li><p>è®¾ç½® [NSString stringWithFormat] æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;name &ldquo;-[NSString stringWithFormat:]&rdquo; (ä¹Ÿæ˜¯é€šè¿‡nameçš„æ–¹å¼)</p></li>
<li><p>b -[NSString stringWithFormat:]</p></li>
</ul>
</li>
<li><p>å¯ä»¥æ·»åŠ  &ndash;shlib xxx.lib æ¥é™åˆ¶åªè®¾ç½®è¿™ä¸ªæ¨¡å—çš„æ–­ç‚¹</p>

<ul>
<li><p>breakpoint set &ndash;name functionA &ndash;shlib foo.dylib</p></li>
<li><p>breakpoint set -n functionA -s foo.dylib</p></li>
</ul>
</li>
<li><p>è®¾ç½®æ¡ä»¶æ–­ç‚¹</p>

<ul>
<li>breakpoint modify -c &lsquo;i == 10&rsquo;</li>
</ul>
</li>
<li><p>å‘½ä¸­næ¬¡ååœæ­¢</p>

<ul>
<li>breakpoint modify -i n</li>
</ul>
</li>
<li><p>å½“å¼€å§‹æ‰§è¡ŒæŸä¸ªqueueçš„æ—¶å€™åœæ­¢</p>

<ul>
<li>breakpoint modify -q &lsquo;queue.name&rsquo;</li>
</ul>
</li>
<li><p>æ˜¾ä¸æ‰€æœ‰æ–­ç‚¹</p>

<ul>
<li><p>breakpoint list</p></li>
<li><p>br l</p></li>
</ul>
</li>
<li><p>åˆ é™¤æ–­ç‚¹</p>

<ul>
<li><p>breakpoint delete 1.1</p></li>
<li><p>br del 1.1</p></li>
</ul>
</li>
<li><p>æ·»åŠ å‘½ä»¤</p>

<ul>
<li><p> (lldb) breakpoint command add 1.1</p></li>
<li><p>Enter your debugger command(s). Type &lsquo;DONE&rsquo; to end.</p></li>
<li><p>bt</p></li>
<li><p>DONE</p></li>
</ul>
</li>
</ul>


<h3>WatchPoint</h3>

<ul>
<li><p>å½“å˜é‡å€¼æ”¹å˜æ—¶è§¦å‘æ–­ç‚¹</p>

<ul>
<li>(lldb) watch set var global</li>
</ul>
</li>
<li><p>æ·»åŠ æ¡ä»¶,(å½“å€¼æ”¹ä¸º5æ—¶æ‰è§¦å‘)</p>

<ul>
<li>(lldb) watch modify -c &lsquo;global == 5&rsquo;</li>
</ul>
</li>
<li><p>å½“æŒ‡é’ˆæŒ‡å‘çš„åœ°å€å†…å­˜æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘</p>

<ul>
<li><p>watchpoint set expression &ndash; myptr</p></li>
<li><p>wa s e &ndash; myptr</p></li>
<li><p>å¦‚æœæ²¡æœ‰æŒ‡å®š -x byte_size ï¼Œé»˜è®¤è§‚å¯ŸæŒ‡é’ˆå¤§å°çš„åŒºåŸŸ</p></li>
</ul>
</li>
</ul>


<h3>æµç¨‹æ§åˆ¶</h3>

<ul>
<li><p>ä»£ç çº§åˆ«å•æ­¥æ‰§è¡Œ</p>

<ul>
<li>step</li>
</ul>
</li>
<li><p>ä»£ç çº§åˆ«æ‰§è¡Œæ´—ä¸€æ¡è¯­å¥</p>

<ul>
<li>next</li>
</ul>
</li>
<li><p>æŒ‡ä»¤çº§åˆ«å•æ­¥</p>

<ul>
<li>stepi</li>
</ul>
</li>
<li><p>æŒ‡å®šçº§åˆ«æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</p>

<ul>
<li>nexti</li>
</ul>
</li>
<li><p>è·³å‡ºå½“å‰å¸§å‡½æ•°</p>

<ul>
<li>finish</li>
</ul>
</li>
</ul>


<h3>æŸ¥çœ‹å˜é‡</h3>

<ul>
<li><p>æŸ¥çœ‹å½“å‰å †æ ˆ</p>

<ul>
<li><p>thread backtrace</p></li>
<li><p>bt</p></li>
</ul>
</li>
<li><p>åˆ‡æ¢å½“å‰å †æ ˆå¸§</p>

<ul>
<li>frame select 3</li>
</ul>
</li>
<li><p>æ˜¾ç¤ºå½“å‰æ ˆå¸§çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ä¿¡æ¯</p>

<ul>
<li>frame var -A</li>
</ul>
</li>
<li><p>ä»¥16è¿›åˆ¶çš„æ ¼å¼ï¼Œæ˜¾ç¤ºå½“å‰æ ˆå±€éƒ¨å˜é‡çš„å€¼</p>

<ul>
<li><p>frame variable &ndash;format x bar</p></li>
<li><p>f v -f x bar</p></li>
</ul>
</li>
<li><p>æ˜¾ä¸å½“å‰æ–‡ä»¶çš„å…¨å±€å˜é‡/é™æ€å˜é‡</p>

<ul>
<li><p>target var</p></li>
<li><p>ta var</p></li>
</ul>
</li>
</ul>


<h3>æ‰§è¡Œè¡¨è¾¾å¼</h3>

<ul>
<li><p>expr (int) printf (&ldquo;Print nine: %d.&rdquo;, 4 + 5)</p></li>
<li><p>expr unsigned int $foo = 5</p></li>
<li><p>è°ƒè¯•çŠ¶æ€ä¸‹åˆ·æ–°ç•Œé¢</p>

<p>  ï»¿* e (void)[CATransation flush]</p></li>
</ul>


<h3>æŸ¥çœ‹å†…å­˜</h3>

<ul>
<li><p>( lldb ) memory read &ndash;format x &ndash;size 4 0xbffff3c0</p>

<ul>
<li>ä»¥16è¿›åˆ¶æ ¼å¼æ˜¾ç¤º0xbffff3c0å¼€å§‹çš„å†…å­˜æ•°æ®ï¼Œæ•°æ®æ˜¯4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå•ä½çš„</li>
</ul>
</li>
<li><p>(lldb)memory read &ndash;outfile /tmp/mem.bin &ndash;binary 0x1000 0x1200</p>

<ul>
<li>æŠŠ0x100 åˆ° 0x1200çš„å†…å­˜æ•°æ®è¾“å‡ºåˆ°æ–‡ä»¶</li>
</ul>
</li>
</ul>


<h3>ä¿®æ”¹å†…å­˜</h3>

<ul>
<li><p>åœ¨bytes+1çš„åœ°æ–¹å†™å…¥ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼š10</p>

<ul>
<li>memory write &lsquo;bytes + 1&rsquo; 10</li>
</ul>
</li>
<li><p>åœ¨bytes+1çš„åœ°æ–¹å†™å…¥å¤§å°ä¸º4å­—èŠ‚çš„æ•°æ®</p>

<ul>
<li>memory write -s 4 &lsquo;byte + 1&rsquo; 15</li>
</ul>
</li>
<li><p>åœ¨byteså¼€å§‹çš„8ä¸ªå­—èŠ‚å†™å…¥1ï¼Œ2ï¼Œ3ï¼Œ4ã€‚æ¯ä¸ªæ•°æ®2å­—èŠ‚</p>

<ul>
<li>memory write -s 2 &lsquo;byte&rsquo; 1 2 3 4</li>
</ul>
</li>
</ul>


<h3>å¯„å­˜å™¨</h3>

<ul>
<li><p>æŸ¥çœ‹å¯„å­˜å™¨æ•°æ®</p>

<ul>
<li>register read</li>
</ul>
</li>
<li><p>æŒ‡å®šæ ¼å¼æŸ¥çœ‹å¯„å­˜å™¨å†…å®¹</p>

<ul>
<li><p>register read &ndash;format x</p></li>
<li><p>help format å¯ä»¥æŸ¥çœ‹ç›¸åº”çš„æ ¼å¼</p></li>
</ul>
</li>
<li><p>ä¿®æ”¹å¯„å­˜å™¨æ•°æ®</p>

<ul>
<li><p>register write rax 123</p></li>
<li><p>register write pc &lsquo;$pc + 8&rsquo;</p></li>
</ul>
</li>
<li><p>å‡½æ•°è°ƒç”¨çº¦å®šï¼Œè¿”å›å€¼æ”¾åœ¨r0ï¼Œå‰é¢3ä¸ªå‚æ•°æ”¾åœ¨r1 ~ r3 é‡Œé¢</p></li>
</ul>


<h3>æ±‡ç¼–</h3>

<ul>
<li><p>æ˜¾ç¤ºå½“å‰å‡½æ•°æ±‡ç¼–ä»£ç </p>

<ul>
<li><p>disassemble &ndash;frame</p></li>
<li><p>dis -f</p></li>
</ul>
</li>
<li><p>æ˜¾ç¤ºæŒ‡å®šå‡½æ•°åçš„æ±‡ç¼–ä»£ç </p>

<ul>
<li><p>disassemble &ndash;name main</p></li>
<li><p>dis -n main</p></li>
</ul>
</li>
<li><p>æ˜¾ç¤ºæŒ‡å®šåœ°å€èŒƒå›´çš„æ±‡ç¼–ä»£ç </p>

<ul>
<li>disassemble &ndash;start-address 0x1eb8 &ndash;end-address 0x1ec3</li>
</ul>
</li>
<li><p>æ˜¾ç¤ºå½“å‰è¡Œçš„æ±‡ç¼–ä»£ç </p>

<ul>
<li><p>disassemble &ndash;line</p></li>
<li><p>dis -l</p></li>
</ul>
</li>
<li><p>æºä»£ç å’Œæ±‡ç¼–ä»£ç æ··åˆæ˜¾ç¤º</p>

<ul>
<li><p>disassemble  &ndash;frame &ndash;mixed</p></li>
<li><p>dis -f -m</p></li>
</ul>
</li>
<li><p>æ˜¾ç¤º16è¿›åˆ¶opcode</p>

<ul>
<li>disassemble &ndash;frame &ndash;bytes</li>
</ul>
</li>
</ul>


<h3>å…¶ä»–</h3>

<ul>
<li><p>åˆå§‹åŒ–æ—¶ä¼šè¯»é…ç½®æ–‡ä»¶</p>

<ul>
<li>~/.lldbinit</li>
</ul>
</li>
<li><p>å¯æŒ‡å®šåˆ«å</p>

<ol>
<li>(lldb) command alias bfl breakpoint set -f %1 -l %2</li>
<li>(lldb) bfl foo.c 12</li>
</ol>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ‰¾å‡ºå¼•èµ·å¼‚å¸¸çš„æ–‡å­—]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/05/25/debugfindcrashtext/"/>
    <updated>2016-05-25T00:23:23+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/05/25/debugfindcrashtext</id>
    <content type="html"><![CDATA[<p>å¤§å®¶å¯èƒ½éƒ½é‡åˆ°è¿‡ï¼Œä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„å­—ç¬¦ï¼Œåœ¨æ’ç‰ˆçš„æ—¶å€™ï¼Œæˆ–è€…åœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
å½“æˆ‘ä»¬è°ƒè¯•çš„æ—¶å€™ï¼ŒåŠ äº†å¼‚å¸¸æ–­ç‚¹ï¼Œå°±ä¼šè§¦å‘æ–­ç‚¹ã€‚
è¿™æ¬¡ä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹ï¼Œå½“å‡ºç°è¿™ç§å¼‚å¸¸çš„æ—¶å€™ï¼Œæ€æ ·æŠŠå¼•èµ·è¿™ä¸ªå¼‚å¸¸çš„æ–‡å­—æ‰¾å‡ºæ¥ã€‚</p>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å‡ºç°è¿™ç§å¼‚å¸¸æ—¶çš„å †æ ˆä¿¡æ¯</p>

<!--MORE-->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) bt
</span><span class='line'>* thread #1: tid = 0x70ed65, 0x0000000118914c6b libc++abi.dylib`__cxa_throw, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
</span><span class='line'>    frame #0: 0x0000000118914c6b libc++abi.dylib`__cxa_throw
</span><span class='line'>    frame #1: 0x00000001311c782f libType1Scaler.dylib`TType1LWFNMultipleMasterHFMXTable::TType1LWFNMultipleMasterHFMXTable(TFontObjectSurrogate const&, int, short, short, int*) + 121
</span><span class='line'>    frame #2: 0x00000001311c7756 libType1Scaler.dylib`TType1LWFNFont::CreateHFMXTable() const + 86
</span><span class='line'>    frame #3: 0x00000001311c76f5 libType1Scaler.dylib`TType1HFMXTableSurrogate::TType1HFMXTableSurrogate(TType1PSFont const&) + 31
</span><span class='line'>    frame #4: 0x00000001311c6ec9 libType1Scaler.dylib`TType1PSFont::GetFontInstanceSpec(TType1Transform const&, FixedPoint&, FixedPoint&, FixedPoint&, FixedPoint&, FixedPoint&, FixedRectangle&, FontMetrics&) const + 647
</span><span class='line'>    frame #5: 0x00000001311c6be4 libType1Scaler.dylib`TType1Strike::GetSpecs(StrikeSpecs&) const + 100
</span><span class='line'>    frame #6: 0x00000001311bff2d libType1Scaler.dylib`Type1GetStrikeSpecs(unsigned int, TStrikeDescription const*, StrikeSpecs*) + 48
</span><span class='line'>    frame #7: 0x000000011aba87a0 libFontParser.dylib`TConcreteFontScaler::GetFontInfo(FPFontInfo*) const + 48
</span><span class='line'>    frame #8: 0x000000011ab80525 libFontParser.dylib`TFPFont::FillFontInfo(TFPFontInfo&) const + 203
</span><span class='line'>    frame #9: 0x000000011ab80412 libFontParser.dylib`TFPFont::GetFontInfo() const + 46
</span><span class='line'>    frame #10: 0x000000011ab803de libFontParser.dylib`FPFontIsMonospaced + 9
</span><span class='line'>    frame #11: 0x0000000113bf63cd CoreGraphics`get_font_info + 244
</span><span class='line'>    frame #12: 0x0000000113b84b47 CoreGraphics`get_font_info + 63
</span><span class='line'>    frame #13: 0x0000000113b84af9 CoreGraphics`CGFontGetNumberOfGlyphs + 9
</span><span class='line'>    frame #14: 0x00000001168131ed CoreText`TBaseFont::CopyGraphicsFont() const + 43
</span><span class='line'>    frame #15: 0x0000000116863446 CoreText`TBaseFont::CopyTable(unsigned int) const + 188
</span><span class='line'>    frame #16: 0x00000001168476fc CoreText`TBaseFont::GetCmapTable() const + 60
</span><span class='line'>    frame #17: 0x000000011685d7a2 CoreText`TBaseFont::GetUnicodeEncoding() const + 58
</span><span class='line'>    frame #18: 0x000000011685c367 CoreText`TBaseFont::GetUnicodeCmapSubHeader(void const**) const + 29
</span><span class='line'>    frame #19: 0x000000011685c506 CoreText`TBaseFont::CopyCharacterSet() const + 206
</span><span class='line'>    frame #20: 0x000000011680a2c2 CoreText`TBaseFont::GetCharacterSetInternal() const + 42
</span><span class='line'>    frame #21: 0x0000000116808211 CoreText`CompareCharSet(__CFCharacterSet const*, TBaseFont const*) + 17
</span><span class='line'>    frame #22: 0x000000011680ff1d CoreText`TDescriptorSource::CopyDescriptorsForRequestFromArray(__CFArray const*, __CFDictionary const*, CFComparisonResult (*)(void const*, void const*, void*), void*, unsigned long, bool) const + 1325
</span><span class='line'>    frame #23: 0x000000011680e47e CoreText`TDescriptorSource::CopyDescriptorsForRequest(__CFDictionary const*, __CFSet const*, CFComparisonResult (*)(void const*, void const*, void*), void*, unsigned long, TCFRef&lt;__CFArray const*&gt;*) const + 2374
</span><span class='line'>    frame #24: 0x000000011680d747 CoreText`TDescriptorSource::CopySystemWideFallbackDescriptorForCharacters(TBaseFont const&, unsigned short const*, long, UIFontFlag, TCFRef&lt;__CFArray const*&gt;*) const + 681
</span><span class='line'>    frame #25: 0x000000011680ee03 CoreText`TDescriptorSource::CopySystemWideFallbackDescriptorForString(TBaseFont const&, __CFString const*, CFRange, UIFontFlag, TCFRef&lt;__CFArray const*&gt;*) const + 199
</span><span class='line'>    frame #26: 0x00000001167f9ab3 CoreText`TFontCascade::CreateSystemWideFallback(__CTFont const*, __CFString const*, CFRange) const + 115
</span><span class='line'>    frame #27: 0x00000001167f99ad CoreText`TFontCascade::CreateFallback(__CTFont const*, __CFString const*, CTEmojiPolicy) const + 1525
</span><span class='line'>    frame #28: 0x00000001167c9204 CoreText`TGlyphEncoder::AppendUnmappedCharRun(unsigned int, TCFRef&lt;CTRun*&gt;&, __CTFont const*, CFRange, CFRange, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TFontCascade const&, TGlyphEncoder::ClusterMatching) + 510
</span><span class='line'>    frame #29: 0x00000001167c8e93 CoreText`TGlyphEncoder::RunUnicodeEncoderRecursively(unsigned int, TCFRef&lt;CTRun*&gt;&&, __CTFont const*, CFRange, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TFontCascade const*, TGlyphEncoder::ClusterMatching, bool) + 1819
</span><span class='line'>    frame #30: 0x00000001167c8703 CoreText`TGlyphEncoder::RunUnicodeEncoder(TCFRef&lt;CTRun*&gt;&&, __CTFont const*, CFRange, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TFontCascade const*) + 137
</span><span class='line'>    frame #31: 0x00000001167c82e0 CoreText`TGlyphEncoder::EncodeChars(CFRange, TAttributes const&, TGlyphList&lt;TDeletedGlyphIndex&gt;&, TGlyphEncoder::Fallbacks) + 1684
</span><span class='line'>    frame #32: 0x00000001167df8a8 CoreText`TTypesetterAttrString::Initialize(__CFAttributedString const*) + 526
</span><span class='line'>    frame #33: 0x00000001167cbe34 CoreText`CTLineCreateWithAttributedString + 63
</span><span class='line'>    frame #34: 0x000000011cdffe3e UIFoundation`__NSStringDrawingEngine + 9479
</span><span class='line'>    frame #35: 0x000000011cdfd824 UIFoundation`-[NSString(NSExtendedStringDrawing) drawWithRect:options:attributes:context:] + 167
</span><span class='line'>    frame #36: 0x0000000114d69b4b UIKit`-[UILabel _drawTextInRect:baselineCalculationOnly:] + 6596
</span><span class='line'>    frame #37: 0x0000000114d6788a UIKit`-[UILabel drawTextInRect:] + 669
</span><span class='line'>    frame #38: 0x0000000114d69caf UIKit`-[UILabel drawRect:] + 100
</span><span class='line'>    frame #39: 0x0000000114bab3e5 UIKit`-[UIView(CALayerDelegate) drawLayer:inContext:] + 495
</span><span class='line'>    frame #40: 0x00000001148237ea QuartzCore`-[CALayer drawInContext:] + 257
</span><span class='line'>    frame #41: 0x000000011508ab47 UIKit`-[_UILabelContentLayer drawInContext:] + 197
</span><span class='line'>    frame #42: 0x0000000114712faa QuartzCore`CABackingStoreUpdate_ + 2725
</span><span class='line'>    frame #43: 0x00000001148234d4 QuartzCore`___ZN2CA5Layer8display_Ev_block_invoke + 68
</span><span class='line'>    frame #44: 0x000000011482334a QuartzCore`CA::Layer::display_() + 1614
</span><span class='line'>    frame #45: 0x0000000114817e87 QuartzCore`CA::Layer::display_if_needed(CA::Transaction*) + 293
</span><span class='line'>    frame #46: 0x0000000114817f17 QuartzCore`CA::Layer::layout_and_display_if_needed(CA::Transaction*) + 35
</span><span class='line'>    frame #47: 0x000000011480c3c9 QuartzCore`CA::Context::commit_transaction(CA::Transaction*) + 277
</span><span class='line'>    frame #48: 0x000000011483a086 QuartzCore`CA::Transaction::commit() + 486
</span><span class='line'>    frame #49: 0x000000011483a7f8 QuartzCore`CA::Transaction::observer_callback(__CFRunLoopObserver*, unsigned long, void*) + 92
</span><span class='line'>    frame #50: 0x0000000118485c37 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ + 23
</span><span class='line'>    frame #51: 0x0000000118485ba7 CoreFoundation`__CFRunLoopDoObservers + 391
</span><span class='line'>    frame #52: 0x000000011847b7fb CoreFoundation`__CFRunLoopRun + 1147
</span><span class='line'>    frame #53: 0x000000011847b0f8 CoreFoundation`CFRunLoopRunSpecific + 488
</span><span class='line'>    frame #54: 0x0000000119682ad2 GraphicsServices`GSEventRunModal + 161
</span><span class='line'>    frame #55: 0x0000000114af0f09 UIKit`UIApplicationMain + 171
</span></code></pre></td></tr></table></div></figure>


<p>å¤§è‡´å¯ä»¥çœ‹åˆ°ï¼Œ æ˜¯UILabelåœ¨ <strong>drawTextInRect</strong>æ—¶ï¼Œè·å–æŸäº›å­—å…ƒä¿¡æ¯æ—¶å‡ºå¼‚å¸¸äº†ã€‚
æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯æƒ³çœ‹ä¸€ä¸‹åˆ°åº•æ˜¯ä»€ä¹ˆæ–‡å­—å¼•èµ·è¿™ä¸ªé—®é¢˜çš„ã€‚</p>

<p>æˆ‘ä»¬éƒ½çŸ¥é“ text æ˜¯å­˜æ”¾åœ¨ UILabel.text çš„å±æ€§ä¸Šï¼Œç¬¬ä¸€å°è±¡éƒ½è®¤ä¸º  <code>po self.text</code> å°±å¯ä»¥çœ‹åˆ°ç½ªé­ç¥¸é¦–äº†ã€‚</p>

<p>OKï¼Œ æˆ‘ä»¬çœ‹ä¸€ä¸‹å®é™…è¾“å‡ºç»“æœã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) po self.text
</span><span class='line'>error: use of undeclared identifier 'self'
</span><span class='line'>error: 1 errors parsing expression</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ°æç¤ºï¼Œæ²¡æœ‰æ‰¾åˆ° self ï¼Œå› ä¸ºå½“å‰æ ˆå¸§å·²ç»å»åˆ°</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>frame #0: 0x0000000118914c6b libc++abi.dylib`__cxa_throw
</span><span class='line'>frame #1: 0x00000001311c782f libType1Scaler.dylib`TType1LWFNMultipleMasterHFMXTable::TType1LWFNMultipleMasterHFMXTable(TFontObjectSurrogate const&, int, short, short, int*) + 121
</span><span class='line'> 
</span><span class='line'> ``` 
</span><span class='line'> æ‰€ä»¥æç¤ºæ²¡æ‰¾åˆ°selfä¹Ÿæ˜¯å¾ˆæ­£å¸¸ï¼Œ é‚£ä¹ˆæˆ‘ä»¬åˆ‡æ¢ä¸€ä¸‹å½“å‰å †æ ˆï¼ŒæŠŠå®ƒåˆ‡æ¢åˆ° ``` [UILabel drawRect:] ``` è¿™ä¸ªå‡½æ•°é‡Œé¢:
</span><span class='line'> 
</span><span class='line'> ```
</span><span class='line'> UIKit`-[UILabel drawRect:]:
</span><span class='line'>0x114d69c4b &lt;+0&gt;:   pushq  %rbp
</span><span class='line'>0x114d69c4c &lt;+1&gt;:   movq   %rsp, %rbp
</span><span class='line'>0x114d69c4f &lt;+4&gt;:   pushq  %rbx
</span><span class='line'>0x114d69c50 &lt;+5&gt;:   subq   $0x48, %rsp
</span><span class='line'>0x114d69c54 &lt;+9&gt;:   movq   %rdi, %rbx
</span><span class='line'>0x114d69c57 &lt;+12&gt;:  testq  %rbx, %rbx
</span><span class='line'>0x114d69c5a &lt;+15&gt;:  je     0x114d69c71               ; &lt;+38&gt;
</span><span class='line'>0x114d69c5c &lt;+17&gt;:  movq   0xa6c4ad(%rip), %rdx      ; "bounds"
</span><span class='line'>0x114d69c63 &lt;+24&gt;:  leaq   -0x30(%rbp), %rdi
</span><span class='line'>0x114d69c67 &lt;+28&gt;:  movq   %rbx, %rsi
</span><span class='line'>0x114d69c6a &lt;+31&gt;:  callq  0x1155c2af6               ; symbol stub for: objc_msgSend_stret
</span><span class='line'>0x114d69c6f &lt;+36&gt;:  jmp    0x114d69c7c               ; &lt;+49&gt;
</span><span class='line'>0x114d69c71 &lt;+38&gt;:  xorps  %xmm0, %xmm0
</span><span class='line'>0x114d69c74 &lt;+41&gt;:  movaps %xmm0, -0x20(%rbp)
</span><span class='line'>0x114d69c78 &lt;+45&gt;:  movaps %xmm0, -0x30(%rbp)
</span><span class='line'>0x114d69c7c &lt;+49&gt;:  movq   0xa7cdd5(%rip), %rsi      ; "drawTextInRect:"
</span><span class='line'>0x114d69c83 &lt;+56&gt;:  movq   -0x18(%rbp), %rax
</span><span class='line'>0x114d69c87 &lt;+60&gt;:  movq   %rax, 0x18(%rsp)
</span><span class='line'>0x114d69c8c &lt;+65&gt;:  movq   -0x20(%rbp), %rax
</span><span class='line'>0x114d69c90 &lt;+69&gt;:  movq   %rax, 0x10(%rsp)
</span><span class='line'>0x114d69c95 &lt;+74&gt;:  movq   -0x30(%rbp), %rax
</span><span class='line'>0x114d69c99 &lt;+78&gt;:  movq   -0x28(%rbp), %rcx
</span><span class='line'>0x114d69c9d &lt;+82&gt;:  movq   %rcx, 0x8(%rsp)
</span><span class='line'>0x114d69ca2 &lt;+87&gt;:  movq   %rax, (%rsp)
</span><span class='line'>0x114d69ca6 &lt;+91&gt;:  movq   %rbx, %rdi
</span><span class='line'>0x114d69ca9 &lt;+94&gt;:  callq  *0xaf0531(%rip)           ; (void *)0x0000000117c64800: objc_msgSend
</span><span class='line'>0x114d69caf &lt;+100&gt;: addq   $0x48, %rsp
</span><span class='line'>0x114d69cb3 &lt;+104&gt;: popq   %rbx
</span><span class='line'>0x114d69cb4 &lt;+105&gt;: popq   %rbp
</span><span class='line'>0x114d69cb5 &lt;+106&gt;: retq   </span></code></pre></td></tr></table></div></figure>


<p>å†çœ‹çœ‹ç»“æœï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) po self.text
</span><span class='line'>error: use of undeclared identifier 'self'
</span><span class='line'>error: 1 errors parsing expression
</span></code></pre></td></tr></table></div></figure>


<p>åŒæ ·ï¼Œä¹Ÿæ˜¯æ²¡æœ‰æ‰¾åˆ°selfæ ‡è¯†ç¬¦ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ä¸Šé¢çš„æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ drawTextInRext çš„æ—¶å€™ï¼Œå®é™…ä¸Šæœ€åä¹Ÿæ˜¯è°ƒç”¨ <code>objc_msgSend</code> è¿™ä¸ªå‡½æ•°ã€‚</p>

<p>ç„¶åæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ <code>objc_msgSend</code> çš„å‡½æ•°åŸå‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OBJC_EXPORT id objc_msgSend(id self, SEL op, ...)
</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œä¼ ç»™objc_msgSendçš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ self å¯¹è±¡ã€‚</p>

<p>è€Œä¸”ä»</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x114d69c7c &lt;+49&gt;:  movq   0xa7cdd5(%rip), %rsi      ; "drawTextInRect:"
</span><span class='line'>0x114d69c83 &lt;+56&gt;:  movq   -0x18(%rbp), %rax
</span><span class='line'>0x114d69c87 &lt;+60&gt;:  movq   %rax, 0x18(%rsp)
</span><span class='line'>0x114d69c8c &lt;+65&gt;:  movq   -0x20(%rbp), %rax
</span><span class='line'>0x114d69c90 &lt;+69&gt;:  movq   %rax, 0x10(%rsp)
</span><span class='line'>0x114d69c95 &lt;+74&gt;:  movq   -0x30(%rbp), %rax
</span><span class='line'>0x114d69c99 &lt;+78&gt;:  movq   -0x28(%rbp), %rcx
</span><span class='line'>0x114d69c9d &lt;+82&gt;:  movq   %rcx, 0x8(%rsp)
</span><span class='line'>0x114d69ca2 &lt;+87&gt;:  movq   %rax, (%rsp)
</span><span class='line'>0x114d69ca6 &lt;+91&gt;:  movq   %rbx, %rdi
</span><span class='line'>0x114d69ca9 &lt;+94&gt;:  callq  *0xaf0531(%rip)           ; (void *)0x0000000117c64800: objc_msgSend
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ åœ¨ drawRect é‡Œé¢ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº† <code>drawTextInRect</code>,æ ¹æ®ä¸€äº›è°ƒç”¨çº¦å®šï¼Œå¯ä»¥åˆ¤æ–­ <code>objc_msgSend</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åå‹æ ˆçš„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥çŒœæµ‹å°±æ˜¯ <strong>rbx</strong>çš„å¯„å­˜å™¨çš„å€¼ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>register read</strong> æŒ‡ä»¤æŸ¥çœ‹å½“å‰å¯„å­˜å™¨çš„å€¼ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) register read
</span><span class='line'>General Purpose Registers:
</span><span class='line'>       rbx = 0x00007f9f833d71e0
</span><span class='line'>       rbp = 0x00007fff5096bf70
</span><span class='line'>       rsp = 0x00007fff5096bf20
</span><span class='line'>       r12 = 0x00007f9f83102850
</span><span class='line'>       r13 = 0x00007f9f833d71e0
</span><span class='line'>       r14 = 0x0000000000000020
</span><span class='line'>       r15 = 0x00007f9f80f119f0
</span><span class='line'>       rip = 0x0000000114d69caf  UIKit`-[UILabel drawRect:] + 100
</span><span class='line'>13 registers were unavailable.
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åæˆ‘ä»¬å°è¯•ä¸€ä¸‹è¾“å‡º rbx çš„å¯¹è±¡ç±»å‹ï¼ˆå¦‚æœå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼‰</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) po [(id)$rbx class]
</span><span class='line'>UILabel
</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ°rbxå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªUILabelå¯¹è±¡ï¼Œæ—¢ç„¶æ‰¾åˆ°UILabelï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“æ‰¾åˆ°ç›¸åº”çš„ text äº†ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) po [(id)$rbx text]
</span><span class='line'>á˜¡ â€AmyğŸŒ€æ™´å¤©å†  à­¨à­§Ë™Ë³â‹†ï»¿
</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ° <strong> á˜¡ â€AmyğŸŒ€æ™´å¤©å†  à­¨à­§Ë™Ë³â‹†ï»¿ </strong> æ˜¯è¿™ä¸ªæ–‡æœ¬å¼•èµ·å¼‚å¸¸ã€‚</p>

<p>å¦‚æœä¸å¥½åˆ¤æ–­å“ªäº›å¯„å­˜å™¨æ˜¯å­˜æ”¾ self å¯¹è±¡çš„è¯ï¼Œå¯ä»¥ä¸€ä¸ªä¸€ä¸ªæ‰“å°ä¸€ä¸‹ç±»å‹è¯•è¯•ã€‚</p>

<h3>æ€»ç»“</h3>

<ul>
<li>å¾ˆå¤šæ—¶å€™å¼‚å¸¸äº†ï¼Œè€Œä¸”ä¸åœ¨æˆ‘ä»¬çš„å‡½æ•°é‡Œé¢ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥å– self æ˜¯å–ä¸åˆ°çš„ã€‚</li>
<li>æ‰€æœ‰æ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨äº†<code>objc_msgSend</code>ï¼Œ è°ƒç”¨çš„å¯¹è±¡ä¼šä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆselfï¼‰ä¼ ç»™å®ƒã€‚</li>
<li>å¯ä»¥é€šè¿‡æŸ¥çœ‹å¯„å­˜å™¨å‘½ä»¤ <code>register read</code>ï¼Œ è·å–åˆ°selfåœ°å€ã€‚</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡<code>frame</code> æŒ‡ä»¤æŸ¥çœ‹å½“å‰æ ˆçš„å‚æ•°ä¿¡æ¯ã€‚ å…·ä½“å¯ä»¥çœ‹çœ‹ <code>help frame</code> çš„è¾“å‡ºä¿¡æ¯ã€‚</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dealloc æ—¶å– Weak Self æ—¶å´©æºƒ]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/05/10/store-weak-crash-in-dealloc/"/>
    <updated>2016-05-10T15:15:20+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/05/10/store-weak-crash-in-dealloc</id>
    <content type="html"><![CDATA[<p>ä»Šå¤©æ— æ„è¿™ä¸­é‡åˆ°ä¸€ä¸ªå¥‡æ€ªçš„å´©æºƒï¼Œå…ˆä¸Šå¼•èµ·å´©æºƒçš„ä»£ç ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)dealloc
</span><span class='line'>{
</span><span class='line'>    __weak __typeof(self)weak_self = self;
</span><span class='line'>    NSLog(@"%@", weak_self);
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>å½“æ‰§è¡Œåˆ°deallocçš„æ—¶å€™ï¼Œç¨‹åºå°±crash æ‰äº†ã€‚</p>

<!--MORE-->


<p> å´©æºƒä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>objc[4572]: Cannot form weak reference to instance (0x160f6f890) of class MFChatRoomBoardController. It is possible that this object was over-released, or is in the process of deallocation.
</span><span class='line'>(lldb) 
</span><span class='line'>error: empty command
</span><span class='line'>(lldb) bt
</span><span class='line'>* thread #1: tid = 0x35914d, 0x0000000182307aac libobjc.A.dylib`_objc_trap(), queue = 'com.apple.main-thread', stop reason = EXC_BREAKPOINT (code=1, subcode=0x182307aac)
</span><span class='line'>  * frame #0: 0x0000000182307aac libobjc.A.dylib`_objc_trap()
</span><span class='line'>    frame #1: 0x0000000182307b24 libobjc.A.dylib`_objc_fatal(char const*, ...) + 88
</span><span class='line'>    frame #2: 0x0000000182319890 libobjc.A.dylib`weak_register_no_lock + 316
</span><span class='line'>    frame #3: 0x0000000182320688 libobjc.A.dylib`objc_initWeak + 224
</span><span class='line'>    frame #4: 0x000000010022bf8c MakeFriends`-[MFChatRoomBoardController dealloc](self=0x0000000160f6f890, _cmd="dealloc") + 36 at MFChatRoomBoardController.m:31
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>å…¶ä¸­ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æ˜ç¡®çœ‹åˆ°è¿™æ ·ä¸€æ®µæè¿°:</p>

<blockquote><p>objc[4572]: Cannot form weak reference to instance (0x160f6f890) of class MFChatRoomBoardController. It is possible that this object was over-released, or is in the process of deallocation.</p></blockquote>

<p>è¯´æ˜ä¸å…è®¸åœ¨ dealloc çš„æ—¶å€™å– weak self.</p>

<p>æŸ¥çœ‹äº†ä¸€ä¸‹ <code>weak_register_no_lock</code> çš„å‡½æ•°ä»£ç ï¼Œæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>id 
</span><span class='line'>weak_register_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id)
</span><span class='line'>{
</span><span class='line'>    objc_object *referent = (objc_object *)referent_id;
</span><span class='line'>    objc_object **referrer = (objc_object **)referrer_id;
</span><span class='line'>
</span><span class='line'>    if (!referent  ||  referent-&gt;isTaggedPointer()) return referent_id;
</span><span class='line'>
</span><span class='line'>    // ensure that the referenced object is viable
</span><span class='line'>    bool deallocating;
</span><span class='line'>    if (!referent-&gt;ISA()-&gt;hasCustomRR()) {
</span><span class='line'>        deallocating = referent-&gt;rootIsDeallocating();
</span><span class='line'>    }
</span><span class='line'>    else {
</span><span class='line'>        BOOL (*allowsWeakReference)(objc_object *, SEL) = 
</span><span class='line'>            (BOOL(*)(objc_object *, SEL))
</span><span class='line'>            object_getMethodImplementation((id)referent, 
</span><span class='line'>                                           SEL_allowsWeakReference);
</span><span class='line'>        if ((IMP)allowsWeakReference == _objc_msgForward) {
</span><span class='line'>            return nil;
</span><span class='line'>        }
</span><span class='line'>        deallocating =
</span><span class='line'>            ! (*allowsWeakReference)(referent, SEL_allowsWeakReference);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if (deallocating) {
</span><span class='line'>        _objc_fatal("Cannot form weak reference to instance (%p) of "
</span><span class='line'>                    "class %s. It is possible that this object was "
</span><span class='line'>                    "over-released, or is in the process of deallocation.",
</span><span class='line'>                    (void*)referent, object_getClassName((id)referent));
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // now remember it and where it is being stored
</span><span class='line'>    weak_entry_t *entry;
</span><span class='line'>    if ((entry = weak_entry_for_referent(weak_table, referent))) {
</span><span class='line'>        append_referrer(entry, referrer);
</span><span class='line'>    } 
</span><span class='line'>    else {
</span><span class='line'>        weak_entry_t new_entry;
</span><span class='line'>        new_entry.referent = referent;
</span><span class='line'>        new_entry.out_of_line = 0;
</span><span class='line'>        new_entry.inline_referrers[0] = referrer;
</span><span class='line'>        for (size_t i = 1; i &lt; WEAK_INLINE_COUNT; i++) {
</span><span class='line'>            new_entry.inline_referrers[i] = nil;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        weak_grow_maybe(weak_table);
</span><span class='line'>        weak_entry_insert(weak_table, &new_entry);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // Do not set *referrer. objc_storeWeak() requires that the 
</span><span class='line'>    // value not change.
</span><span class='line'>
</span><span class='line'>    return referent_id;
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹å‡ºï¼Œruntime æ˜¯é€šè¿‡æ£€æŸ¥å¼•ç”¨è®¡æ•°çš„ä¸ªæ•°æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨ dealloctingï¼Œ ç„¶åé€šè¿‡</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (deallocating) {
</span><span class='line'>    _objc_fatal("Cannot form weak reference to instance (%p) of "
</span><span class='line'>                "class %s. It is possible that this object was "
</span><span class='line'>                "over-released, or is in the process of deallocation.",
</span><span class='line'>                (void*)referent, object_getClassName((id)referent));
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ®µä»£ç è®©ç¨‹åºcrashã€‚</p>

<p>å†çœ‹ä¸€ä¸‹ _objc_fatal è¿™ä¸ªå‡½æ•°</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void _objc_fatal(const char *fmt, ...)
</span><span class='line'>{
</span><span class='line'>    va_list ap; 
</span><span class='line'>    char *buf1;
</span><span class='line'>    char *buf2;
</span><span class='line'>
</span><span class='line'>    va_start(ap,fmt); 
</span><span class='line'>    vasprintf(&buf1, fmt, ap);
</span><span class='line'>    va_end (ap);
</span><span class='line'>
</span><span class='line'>    asprintf(&buf2, "objc[%d]: %s\n", getpid(), buf1);
</span><span class='line'>    _objc_syslog(buf2);
</span><span class='line'>    _objc_crashlog(buf2);
</span><span class='line'>
</span><span class='line'>    _objc_trap();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å®é™…ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¸€æ®µä¿¡æ¯ï¼Œç„¶åè°ƒç”¨ _bojc_trap() å¼•èµ· crash. è€Œæœ€åä¸€ä¸ªå‡½æ•°è°ƒç”¨åˆšå¥½ä¹Ÿå¯¹ä¸Šæˆ‘ä»¬ä¹‹å‰çš„å´©æºƒå †æ ˆã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[_delegateScrollViewAnimationEnded Crashå¤„ç†]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/03/30/uiscrollview-delegatescrollviewanimationended-crash/"/>
    <updated>2016-03-30T00:57:31+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/03/30/uiscrollview-delegatescrollviewanimationended-crash</id>
    <content type="html"><![CDATA[<p>åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤šæ¬¡é‡åˆ°UIScrollViewæ»‘åŠ¨æ—¶å¼•èµ·çš„å´©æºƒï¼Œåœ¨è¿™é‡Œåˆ†æä¸€ä¸‹ï¼Œmark ä¸‹å¤„ç†è¿‡ç¨‹ã€‚</p>

<p>å…ˆçœ‹ä¸€ä¸‹å´©æºƒå †æ ˆï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(lldb) bt all
</span><span class='line'>* thread #1: tid = 0x4bb501, 0x00000001058451a8 CoreFoundation`___forwarding___ + 776, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS  (code=EXC_I386_GPFLT)
</span><span class='line'>    frame #0: 0x00000001058451a8 CoreFoundation`___forwarding___ + 776
</span><span class='line'>    frame #1: 0x0000000105844e18 CoreFoundation`__forwarding_prep_0___ + 120
</span><span class='line'>  * frame #2: 0x0000000105d6884d UIKit`-[UIScrollView(UIScrollViewInternal) _delegateScrollViewAnimationEnded] + 46
</span><span class='line'>    frame #3: 0x0000000105d6894f UIKit`-[UIScrollView(UIScrollViewInternal) _scrollViewAnimationEnded:finished:] + 181
</span><span class='line'>    frame #4: 0x0000000105dddab7 UIKit`-[UIAnimator stopAnimation:] + 395
</span><span class='line'>    frame #5: 0x0000000105dde0bf UIKit`-[UIAnimator(Static) _advanceAnimationsOfType:withTimestamp:] + 234
</span><span class='line'>    frame #6: 0x00000001095a5747 QuartzCore`CA::Display::DisplayLinkItem::dispatch() + 37
</span><span class='line'>    frame #7: 0x00000001095a560f QuartzCore`CA::Display::DisplayLink::dispatch_items(unsigned long long, unsigned long long, unsigned long long) + 315
</span><span class='line'>    frame #8: 0x000000010584df64 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 20
</span><span class='line'>    frame #9: 0x000000010584db25 CoreFoundation`__CFRunLoopDoTimer + 1045
</span><span class='line'>    frame #10: 0x0000000105810e5d CoreFoundation`__CFRunLoopRun + 1901
</span><span class='line'>    frame #11: 0x0000000105810486 CoreFoundation`CFRunLoopRunSpecific + 470
</span><span class='line'>    frame #12: 0x0000000108e799f0 GraphicsServices`GSEventRunModal + 161
</span><span class='line'>    frame #13: 0x0000000105cd1420 UIKit`UIApplicationMain + 1282
</span><span class='line'>    frame #14: 0x000000010504f32f UIScrollViewDelegate`main(argc=1, argv=0x00007fff5abb0360) + 111 at main.m:14
</span><span class='line'>    frame #15: 0x0000000107e5e145 libdyld.dylib`start + 1
</span><span class='line'>    </span></code></pre></td></tr></table></div></figure>


<!--MORE-->


<p>ä»å´©æºƒä¿¡æ¯é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <strong> stop reason = EXC_BAD_ACCESS </strong>ï¼Œ éæ³•åœ°å€è®¿é—®ï¼ˆé‡æŒ‡é’ˆï¼‰ã€‚ä»å †æ ˆ <strong>[UIAnimator stopAnimation:] -> [UIScrollView(UIScrollViewInternal) _scrollViewAnimationEnded:finished:] </strong> å¯ä»¥çœ‹å‡ºæ˜¯åŠ¨ç”»å®Œæˆåï¼Œè°ƒç”¨scrollviewçš„æ–¹æ³•å¼•èµ·çš„éæ³•è®¿é—®ã€‚ç»è¿‡å®éªŒéªŒè¯ï¼Œæ˜¯scrollview.delegate å¼•èµ·çš„ã€‚ <strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œscrollviewåœ¨åšåŠ¨ç”»çš„è¿‡ç¨‹ä¸­ï¼Œscrollview.delegate è¢«é‡Šæ”¾äº†ã€‚</strong>*</p>

<p>ç®€å•å†™äº†ä¸€äº›æµ‹è¯•ä»£ç é‡ç°äº†è¿™ä¸ªå´©æºƒ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@implementation ScrollViewController
</span><span class='line'>
</span><span class='line'>- (IBAction)onBackClick:(id)sender
</span><span class='line'>{
</span><span class='line'>    [self.scrollview setContentOffset:CGPointMake(0, self.scrollview.bounds.size.height * 3) animated:YES];
</span><span class='line'>    [self.navigationController popViewControllerAnimated:NO];
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>åœ¨iOS7 å’Œ iOS8 çš„ç³»ç»Ÿä¸‹ï¼Œä¸€ç‚¹è¿”å›æŒ‰é’®ï¼Œpop å‡ºå½“å‰é¡µé¢ï¼Œå°±ä¼šé©¬ä¸Šå´©æºƒã€‚</li>
<li>åœ¨iOS9ä¸‹æ²¡æœ‰é—®é¢˜ï¼ˆç”±äºå±æ€§ä¿®é¥°ç¬¦æ”¹æˆweakï¼‰</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//iOS9 ä»¥å‰
</span><span class='line'>@property(nonatomic,unsafe_unretain) id&lt;UIScrollViewDelegate&gt; delegate; 
</span><span class='line'>
</span><span class='line'>//iOS9
</span><span class='line'>@property(nullable,nonatomic,weak) id&lt;UIScrollViewDelegate&gt; delegate; 
</span></code></pre></td></tr></table></div></figure>


<h3>è§£å†³æ–¹æ³•ï¼š</h3>

<p>å´©æºƒçš„åŸå› å·²ç»å¾ˆæ˜ç¡®ï¼Œåªè¦å¯ä»¥ä¿è¯UIScrollView çš„ delegateå¯¹è±¡åœ¨é‡Šæ”¾çš„æ—¶å€™ï¼ŒæŠŠ<code>scrollview.dlegate = nil;</code> å°±å¯ä»¥è§£å†³é—®é¢˜ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@implementation ScrollViewController
</span><span class='line'>- (void)dealloc {
</span><span class='line'>  self.scrollview.delegate = nil;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>ä¸»åŠ¨è®¾ç½® scrollview.delegate = nil; å¯ä»¥å¾ˆå¥½çš„è§£å†³å´©æºƒã€‚ä½†æ˜¯ç¨ä¸æ³¨æ„ï¼Œé¡¹ç›®ç»„çš„å…¶ä»–å¼€å‘åŒäº‹åˆå¾ˆå®¹æ˜“å¿˜è®°ï¼Œæˆ–è€…ä¸€ä¸å°å¿ƒï¼Œåˆå¼•èµ·å´©æºƒäº†ã€‚æœ‰æ²¡æœ‰åŠæ³•å¯ä»¥ä¸€åŠ³æ°¸é€¸å‘¢ï¼Ÿ</p>

<h3>æ›´å¥½çš„è§£å†³æ–¹æ³•ï¼š</h3>

<p>ä¸»è¦æ€è·¯ï¼šé€šè¿‡Runtimeï¼Œä¿®æ”¹ dealloc æ–¹æ³•ï¼Œè®©ä»£ç†å¯¹è±¡åœ¨é‡Šæ”¾æ—¶è‡ªåŠ¨æŠŠscrollview.delegateç½®ç©ºã€‚</p>

<ol>
<li><p>é¦–å…ˆï¼Œé€šè¿‡ <strong>method swizzling</strong> ç»™NSObjectæ·»åŠ  deallocBlock <a href="https://github.com/kaihaodir/BSUiKit/blob/master/NSObject%2BDealloc.m">æŸ¥çœ‹å®Œæˆä»£ç </a></p>

<pre><code class="`"> typedef void (^DeallocCallback)();

 @interface NSObject(Deallocing)

 + (void)hookNSObjectDealloc;

 - (void)setDeallocCallback:(DeallocCallback)callback;

 - (DeallocCallback)deallocCallback;

 @end



 @implementation NSObject(Deallocing)
 - (void)myselfDealloc {
     DeallocCallback callback = [self deallocCallback];
     if (callback) {
         callback(); //å¯¹è±¡é‡Šæ”¾å‰çš„ä¸»è¦æ“ä½œ
     }

 [self originalDealloc];
 }
 @end
</code></pre></li>
<li><p>é€šè¿‡<strong>method swizzling</strong> ä¿®æ”¹UIScrollView çš„ <strong>setDelegate</strong> æ–¹æ³•</p>

<pre><code class="`"> - (void)myselfSetDelegate:(NSObject *)delegate
 {
     if (delegate) {
         UIScrollView * __weak weak_self = (UIScrollView *)self;
         [delegate setDeallocCallback:^{
             weak_self.delegate = nil;
         }];
     }
     //è°ƒç”¨åŸæ¥æ–¹æ³•
     [self originalSetDelegate:delegate];
 }   
</code></pre></li>
<li><p>åœ¨Appåˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨ä¸€ä¸‹ ScrollView çš„ swizzling æ–¹æ³•ï¼Œå°±å¯ä»¥è§£å†³è¿™ç±»å‹çš„å´©æºƒï¼ˆåŒ…æ‹¬ï¼šUITableView, UIWebView, UICollectionView åŠ¨ç”»æ—¶delegateè¢«é‡Šæ”¾å¼•èµ·çš„å´©æºƒï¼‰</p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSTimer ä½¿ç”¨æ³¨æ„äº‹é¡¹]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/03/21/nstimer-retain-target/"/>
    <updated>2016-03-21T23:13:50+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/03/21/nstimer-retain-target</id>
    <content type="html"><![CDATA[<p>NSTimeræ˜¯iosä¸Šæ¯”è¾ƒå¸¸ç”¨çš„å®šæ—¶å™¨ç»„ä»¶ï¼Œåœ¨ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åï¼Œå‘ç°æœ‰äº›åœ°æ–¹æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹çš„ã€‚</p>

<ol>
<li><p>NSTimer æ˜¯éœ€è¦é…åˆNSRunLoop æ‰å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚</p>

<pre><code class="` "> + (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)seconds
                              invocation:(NSInvocation *)invocation
                                 repeats:(BOOL)repeats

 + (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)ti 
                                       target:(id)aTarget 
                                     selector:(SEL)aSelector 
                                     userInfo:(nullable id)userInfo 
                                     repeats:(BOOL)yesOrNo;
</code></pre>

<p> ä½¿ç”¨è¿™ä¸ªç±»æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨æ·»åŠ åˆ°å½“å‰çš„RunLoopé‡Œé¢ã€‚å…³äºRunLoopçš„ä»‹ç»ç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™ï¼Œæ¨èçœ‹çœ‹ <a href="http://blog.ibireme.com/2015/05/18/runloop/">æ·±å…¥ç†è§£RunLoop</a>ã€‚
 <!--MORE--></p></li>
<li><p>å½“RunLoopå¤„äºUITrackingRunLoopModeæ¨¡å¼çš„æ—¶å€™ï¼ˆæ»‘åŠ¨UIScrollViewçš„æ—¶å€™ï¼‰ï¼Œä½¿ç”¨</p>

<pre><code>scheduledTimerWithTimeInterval:(NSTimeInterval)seconds
                    invocation:(NSInvocation *)invocation
                       repeats:(BOOL)repeats
</code></pre>

<p>çš„ç±»æ–¹æ³•åˆ›å»ºçš„Timerï¼Œæ˜¯ä¸ä¼šæ”¶åˆ°å“åº”äº‹ä»¶ã€‚åªæœ‰RunLoopåˆ‡æ¢åˆ°Defaultæ¨¡å¼æ—¶æ‰å¯ä»¥æ­£å¸¸å“åº”ã€‚å¦‚æœå¸Œæœ›æ»‘åŠ¨æ—¶ä¹Ÿå¯ä»¥å“åº”Timeræ—¶é—´ï¼Œéœ€è¦æŠŠTimeråŠ åˆ°RunLoopå¹¶æŒ‡å®šæ¨¡å¼ä¸º<strong>NSRunLoopCommonModes</strong></p>

<pre><code>NSTimer *timer = [NSTimer timerWithTimeInterval:0.5 target:self selector:@selector(test) userInfo:nil repeats:YES];
[[NSRunLoop mainRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];
</code></pre></li>
<li><p>NSTimer ä¼šå¼ºå¼•ç”¨ target å¯¹è±¡ï¼Œå¾ˆå®¹æ˜“é€ æˆå†…å­˜æ³„éœ²æˆ–è€…å…¶å®ƒå› ç”Ÿå‘½å‘¨æœŸå’Œé¢„æœŸä¸ä¸€è‡³å¯¼è‡´çš„é—®é¢˜ã€‚</p>

<p> æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µå¸¸è§çš„äº‹ä¾‹ä»£ç </p>

<pre><code class="`"> @implementation TViewController
 {
     NSTimer *_timer;
 }

 - (void)dealloc
 {
     NSLog(@"%s", __func__);
 }

 - (void)viewDidLoad
 {
     [super viewDidLoad];
     _timer = [NSTimer scheduledTimerWithTimeInterval:1
                                               target:self 
                                             selector:@selector(onTimeout) 
                                             userInfo:nil 
                                              repeats:YES];
 }

 - (void)onTimeout
 {
     NSLog(@"%s", __func__);
 }

 @end
</code></pre>

<p> å¤§å®¶å¯èƒ½ä¼šè§‰å¾—ï¼Œå½“è¿™ä¸ªViewControllerè¢« pop æ‰åä¼šæ­£å¸¸é‡Šæ”¾ï¼Œtimer ä¹Ÿä¼šåœæ‰ã€‚ä½†å®é™…çš„æƒ…å†µä¸æ˜¯ä½ æƒ³çš„é‚£æ ·ã€‚ä»¥ä¸‹logæ˜¯Pushè¿™ä¸ªViewControlleråï¼Œç„¶åç‚¹å‡»è¿”å›çš„è¿‡ç¨‹ã€‚</p>

<p> 2016-03-24 00:42:19.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 2016-03-24 00:42:20.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 2016-03-24 00:42:21.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 2016-03-24 00:42:22.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 <strong>2016-03-24 00:42:23.369 NSTimerDemo[14916:3982566] -[TViewController viewDidDisappear:]</strong>
 2016-03-24 00:42:23.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 2016-03-24 00:42:24.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]
 2016-03-24 00:42:25.663 NSTimerDemo[14916:3982566] -[TViewController onTimeout]</p>

<p> ä»æ—¥å¿—ä¸Šæ¥çœ‹ï¼Œdeallocæ–¹æ³•ç¡®å®æ²¡æœ‰æ‰§è¡Œï¼Œè€Œä¸”timeräº‹ä»¶è¿˜ä¸€ç›´åœ¨è§¦å‘ã€‚</p>

<p> OK,æ—¢ç„¶Timerå¼ºå¼•ç”¨äº†ViewControllerï¼Œé‚£æŠŠViewControlleræ”¹æˆ<strong>__weak</strong>ä¸å°±æ˜¯å¯ä»¥è§£å†³é—®é¢˜äº†ï¼Ÿ
 äºæ˜¯æˆ‘ä»¬æŠŠåˆ›å»ºTimerçš„ä»£ç æ”¹æˆ</p>

<pre><code class="`"> __weak typeof(self) weak_self = self;
 _timer = [NSTimer scheduledTimerWithTimeInterval:1
                                           target:weak_self
                                         selector:@selector(onTimeout)
                                         userInfo:nil
                                          repeats:YES];
</code></pre>

<p> å‘ç°è¾“å‡ºçš„logå’Œä¹‹å‰çš„ä¸€æ ·ï¼Œéš¾é“weakå¯¹è±¡æ ¹æœ¬æ²¡èµ·ä½œç”¨ï¼Ÿ
 ç”¨InstrementæŸ¥çœ‹äº†ä¸€ä¸‹å†…å­˜æƒ…å†µï¼Œå‘ç°çœŸçš„æ˜¯Timerå¼ºå¼•ç”¨Targetå¯¹è±¡</p>

<p> <img src="http://7xryar.com1.z0.glb.clouddn.com/NSTimer-Retain-Target.png" alt="Timer Retain Target" /></p>

<p> ç›®å‰ä¸»è¦æ˜¯å¤„äºä¸€ä¸ªé—­ç¯ï¼ˆç¯å½¢å¼•ç”¨ï¼‰çš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•æ‰“ç ´è¿™ç§çŠ¶æ€ï¼Œè€Œä¸”<strong>__weak</strong>è®¾ç½®ç»™Timerä¹Ÿä¸ä¼šç ´åTimerå¼ºå¼•ç”¨Targetã€‚</p>

<p> äºæ˜¯ï¼Œæˆ‘ä»¬å¼•ç”¨ä¸€ä¸ªåŒ…è£…å¯¹è±¡ï¼Œè®©Timerå¼ºå¼•ç”¨è¿™ä¸ªåŒ…è£…å¯¹è±¡ï¼ŒåŒ…è£…å¯¹è±¡å¼±å¼•ç”¨Target(ViewController)
 ViewController &mdash;> Timer &mdash;>Wrapper &hellip;>ViewController è¿™æ ·å°±å¯ä»¥ç ´åç¯å½¢å¼•ç”¨ã€‚</p>

<pre><code class="`"> @Interface Wrapper
 @property (weak, nonatom) id target;
 @end
</code></pre>

<p> é‚£ä¹ˆåˆ›å»ºTimerçš„ç±»æ–¹æ³•çš„Targetå¯¹è±¡ä¸æ˜¯ä¼ <code>self</code>, è€Œæ˜¯ä¼  wrapper å¯¹è±¡ã€‚
 å¦å¤–ï¼Œwrapperå¯¹è±¡è¿˜è¦æŠŠTimerçš„äº‹ä»¶ä¼ é€’åˆ°çœŸæ­£çš„targetä¸Šã€‚</p>

<p> è¯¦ç»†çš„ Timer Wrapper å¯ä»¥çœ‹å®Œä»£ç  <a href="https://github.com/kaihaodir/BSUiKit/blob/master/BSTimer.h">BSTimer</a></p>

<p> æœ€åå…¶å®å¯ä»¥ç”¨dispatch_timeè§£å†³å¼ºå¼•ç”¨é—®é¢˜ï¼Œä½†æ˜¯dispatch_timeåœ¨æš‚åœåŠŸèƒ½ä¸Šå¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Arcä¸‹NSExceptionæœ‰å¯èƒ½ä¼šå†…å­˜æ³„éœ²]]></title>
    <link href="http://kaihaodir.github.io/blog/2016/03/13/arc-nsexception-cause-memory-leak/"/>
    <updated>2016-03-13T17:00:52+08:00</updated>
    <id>http://kaihaodir.github.io/blog/2016/03/13/arc-nsexception-cause-memory-leak</id>
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨Instrumnentså¯¹ç¨‹åºè¿›è¡Œå†…å­˜æµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç°æœ‰å‡ å¤„å¼‚å¸¸å¤„ç†çš„åœ°æ–¹æç¤ºå†…å­˜æ³„éœ²ã€‚ç»è¿‡åˆ†æå¾—çŸ¥ï¼Œ<strong>å› ä¸ºå¼‚å¸¸å¤„ç†ï¼Œæ”¹å˜ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œå¯¼è‡´ç¼–è¯‘ç”Ÿæˆçš„ release ä»£ç æ²¡æœ‰æ‰§è¡Œ</strong>ã€‚</p>

<!--more-->


<p>ç®€å•å†™äº†äº›æµ‹è¯•ä»£ç éªŒè¯ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidLoad {
</span><span class='line'>    
</span><span class='line'>    [super viewDidLoad];
</span><span class='line'>    
</span><span class='line'>    @try {
</span><span class='line'>        NSMutableArray *stringList = [[NSMutableArray alloc] init];
</span><span class='line'>        for (int i = 0; i &lt; 100; i++) {
</span><span class='line'>            [stringList addObject: @"string instance."];
</span><span class='line'>        }
</span><span class='line'>        [self throwException];
</span><span class='line'>    }
</span><span class='line'>    @catch (NSException *exception) {
</span><span class='line'>        NSLog(@"catch Exception : %@", exception);
</span><span class='line'>    }
</span><span class='line'>    @finally {
</span><span class='line'>        
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)throwException
</span><span class='line'>{
</span><span class='line'>    [NSException raise:@"An Exception." format:@"Exception Description."];
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>åå¤è¿›å‡ºè¿™ä¸ªé¡µé¢å‡ æ¬¡åï¼Œåœ¨Instrumentsä¸Šæœç„¶çœ‹åˆ°æç¤ºå†…å­˜æ³„éœ²ï¼Œè€Œä¸”æ³„éœ²çš„åœ°æ–¹å°±æŒ‡æ˜æ˜¯ <code>@try{ }</code> é‡Œé¢åˆ›å»ºçš„å¯¹è±¡ã€‚</p>

<p><img src="http://7xryar.com1.z0.glb.clouddn.com/exception-memory-leak.png" alt="img" /></p>

<h4>è§£å†³æ€è·¯</h4>

<p>1, å°½é‡ä¸è¦åœ¨@try{}é‡Œé¢æœ‰æ“ä½œï¼Œå¯¼è‡´å¯¹è±¡çš„å¼•ç”¨å¼•ç”¨è®¡æ•°å¢åŠ ã€‚<code>@try{ }</code> è¯­å¥å—é‡Œé¢åªæœ‰æœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„è¯­å¥ã€‚</p>

<p><strong>ä¿®æ”¹åçš„ä»£ç :</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidLoad {
</span><span class='line'>    
</span><span class='line'>    [super viewDidLoad];
</span><span class='line'>    
</span><span class='line'>    NSMutableArray *stringList = [[NSMutableArray alloc] init];
</span><span class='line'>    for (int i = 0; i &lt; 100; i++) {
</span><span class='line'>        [stringList addObject: @"string instance."];
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    @try {
</span><span class='line'>        [self throwException];
</span><span class='line'>    }
</span><span class='line'>    @catch (NSException *exception) {
</span><span class='line'>        NSLog(@"catch Exception : %@", exception);
</span><span class='line'>    }
</span><span class='line'>    @finally {
</span><span class='line'>        
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åç”¨Instrumentsæ£€æŸ¥ä¸€ä¸‹ï¼Œä¸€åˆ‡æ­£å¸¸äº†ã€‚</p>

<p>2, æŸ¥çœ‹äº†è‹¹æœçš„å¼€å‘æ–‡æ¡£ï¼Œå‘ç°æœ‰è¿™ä¹ˆä¸€æ®µæè¿°:</p>

<blockquote><pre><code>By default in Objective C, ARC is not exception-safe for normal releases:
It does not end the lifetime of __strong variables when their scopes are abnormally terminated by an exception.
It does not perform releases which would occur at the end of a full-expression if that full-expression throws an exception.
A program may be compiled with the option -fobjc-arc-exceptions in order to enable these, or with the option -fno-objc-arc-exceptions to explicitly disable them, with the last such argument â€œwinningâ€.
</code></pre></blockquote>
]]></content>
  </entry>
  
</feed>
